{% extends "base.html" %}

{% block title %}Monitoring Dashboard - Cold Email Infrastructure{% endblock %}

{% block extra_css %}
<style>
    .monitor-card {
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,.1);
        margin-bottom: 25px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .monitor-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,.15);
    }
    .monitor-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .monitor-card-body {
        padding: 20px;
    }
    .metric-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
        transition: transform 0.3s ease;
    }
    .metric-card:hover {
        transform: scale(1.05);
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    .metric-label {
        opacity: 0.9;
        font-size: 0.9rem;
    }
    .metric-trend {
        font-size: 0.8rem;
        margin-top: 5px;
    }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    .chart-small {
        height: 200px;
    }
    
    .queue-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin: 5px 0;
        border-radius: 8px;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
    }
    .queue-item.pending { border-left-color: #ffc107; }
    .queue-item.processing { border-left-color: #17a2b8; }
    .queue-item.failed { border-left-color: #dc3545; }
    .queue-item.completed { border-left-color: #28a745; }
    
    .log-entry {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        padding: 8px;
        margin: 2px 0;
        border-radius: 4px;
        border-left: 3px solid #6c757d;
    }
    .log-error { 
        background: #f8d7da; 
        border-left-color: #dc3545; 
        color: #721c24;
    }
    .log-warning { 
        background: #fff3cd; 
        border-left-color: #ffc107; 
        color: #856404;
    }
    .log-info { 
        background: #d4edda; 
        border-left-color: #28a745; 
        color: #155724;
    }
    .log-debug { 
        background: #d1ecf1; 
        border-left-color: #17a2b8; 
        color: #0c5460;
    }
    
    .log-container {
        height: 400px;
        overflow-y: auto;
        background: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-online { background: #28a745; }
    .status-warning { background: #ffc107; }
    .status-offline { background: #dc3545; }
    
    .alert-config-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .performance-gauge {
        text-align: center;
        padding: 20px;
    }
    .gauge-value {
        font-size: 3rem;
        font-weight: bold;
        margin: 10px 0;
    }
    .gauge-good { color: #28a745; }
    .gauge-warning { color: #ffc107; }
    .gauge-critical { color: #dc3545; }
    
    .refresh-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    .refresh-btn:hover {
        transform: rotate(180deg);
        color: white;
    }
    .refresh-btn.spinning {
        animation: spin 1s linear infinite;
    }
    
    .real-time-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        margin-right: 5px;
        animation: pulse 2s infinite;
    }
    
    .tab-pane {
        min-height: 500px;
    }
</style>
{% endblock %}

{% block content %}
<div class="col-12">
    <div class="main-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line text-primary"></i> Real-time Monitoring Dashboard</h2>
            <div>
                <span class="real-time-indicator"></span>
                <small class="text-muted me-3">Live Updates</small>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshAllData()">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh All
                </button>
            </div>
        </div>

        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">System Status</div>
                    <div class="metric-value" id="systemStatus">
                        <span class="status-indicator status-online"></span>
                        Online
                    </div>
                    <div class="metric-trend" id="systemUptime">Uptime: --</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Emails Today</div>
                    <div class="metric-value" id="emailsToday">0</div>
                    <div class="metric-trend trend-up" id="emailsTrend">
                        <i class="fas fa-arrow-up"></i> 0% from yesterday
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Success Rate</div>
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-trend trend-neutral" id="successTrend">
                        <i class="fas fa-minus"></i> No change
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Queue Size</div>
                    <div class="metric-value" id="queueSize">0</div>
                    <div class="metric-trend" id="queueTrend">
                        Processing time: --
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Tabs -->
        <ul class="nav nav-tabs" id="monitorTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab">
                    <i class="fas fa-tachometer-alt"></i> System Metrics
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="delivery-tab" data-bs-toggle="tab" data-bs-target="#delivery" type="button" role="tab">
                    <i class="fas fa-paper-plane"></i> Email Delivery
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">
                    <i class="fas fa-list"></i> Queue Monitor
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                    <i class="fas fa-file-alt"></i> Error Logs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                    <i class="fas fa-chart-area"></i> Performance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                    <i class="fas fa-bell"></i> Alerts
                </button>
            </li>
        </ul>

        <div class="tab-content" id="monitorTabContent">
            <!-- System Metrics Tab -->
            <div class="tab-pane fade show active" id="metrics" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-server"></i> Server Resources</h5>
                                <button class="refresh-btn" onclick="refreshServerMetrics()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="monitor-card-body">
                                <div class="row">
                                    <div class="col-4">
                                        <div class="performance-gauge">
                                            <div class="gauge-value gauge-good" id="cpuUsage">0%</div>
                                            <small>CPU Usage</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="performance-gauge">
                                            <div class="gauge-value gauge-good" id="memoryUsage">0%</div>
                                            <small>Memory</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="performance-gauge">
                                            <div class="gauge-value gauge-good" id="diskUsage">0%</div>
                                            <small>Disk Space</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-container chart-small">
                                    <canvas id="resourceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-network-wired"></i> Network Statistics</h5>
                                <button class="refresh-btn" onclick="refreshNetworkMetrics()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="monitor-card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="metric-card">
                                            <div class="metric-label">Data In</div>
                                            <div class="metric-value" id="networkIn">0 MB</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-card">
                                            <div class="metric-label">Data Out</div>
                                            <div class="metric-value" id="networkOut">0 MB</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-container chart-small">
                                    <canvas id="networkChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Delivery Tab -->
            <div class="tab-pane fade" id="delivery" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-chart-line"></i> Email Delivery Statistics</h5>
                                <button class="refresh-btn" onclick="refreshDeliveryStats()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="monitor-card-body">
                                <div class="chart-container">
                                    <canvas id="deliveryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-pie-chart"></i> Delivery Breakdown</h5>
                            </div>
                            <div class="monitor-card-body">
                                <div class="chart-container">
                                    <canvas id="deliveryPieChart"></canvas>
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-circle text-success"></i> Delivered</span>
                                        <span id="deliveredCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-circle text-warning"></i> Pending</span>
                                        <span id="pendingCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-circle text-danger"></i> Bounced</span>
                                        <span id="bouncedCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><i class="fas fa-circle text-info"></i> Deferred</span>
                                        <span id="deferredCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue Monitor Tab -->
            <div class="tab-pane fade" id="queue" role="tabpanel">
                <div class="monitor-card">
                    <div class="monitor-card-header">
                        <h5><i class="fas fa-list"></i> Email Queue Status</h5>
                        <div>
                            <button class="btn btn-outline-light btn-sm me-2" onclick="pauseQueue()">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button class="btn btn-outline-light btn-sm me-2" onclick="resumeQueue()">
                                <i class="fas fa-play"></i> Resume
                            </button>
                            <button class="refresh-btn" onclick="refreshQueue()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="monitor-card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Queue Status</div>
                                    <div class="metric-value" id="queueStatus">Running</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Processing Rate</div>
                                    <div class="metric-value" id="processingRate">0/min</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Avg Wait Time</div>
                                    <div class="metric-value" id="avgWaitTime">0s</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Failed Jobs</div>
                                    <div class="metric-value" id="failedJobs">0</div>
                                </div>
                            </div>
                        </div>
                        <h6>Recent Queue Items</h6>
                        <div id="queueList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Queue items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Logs Tab -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
                <div class="monitor-card">
                    <div class="monitor-card-header">
                        <h5><i class="fas fa-file-alt"></i> System Logs</h5>
                        <div>
                            <select class="form-select form-select-sm me-2" id="logLevel" style="width: auto; display: inline-block;">
                                <option value="all">All Levels</option>
                                <option value="error">Errors</option>
                                <option value="warning">Warnings</option>
                                <option value="info">Info</option>
                                <option value="debug">Debug</option>
                            </select>
                            <button class="btn btn-outline-light btn-sm me-2" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button class="refresh-btn" onclick="refreshLogs()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="monitor-card-body">
                        <div class="log-container" id="logContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading logs...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-pane fade" id="performance" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-tachometer-alt"></i> Response Times</h5>
                            </div>
                            <div class="monitor-card-body">
                                <div class="chart-container">
                                    <canvas id="responseTimeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-chart-bar"></i> Throughput</h5>
                            </div>
                            <div class="monitor-card-body">
                                <div class="chart-container">
                                    <canvas id="throughputChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="monitor-card">
                    <div class="monitor-card-header">
                        <h5><i class="fas fa-database"></i> Database Performance</h5>
                    </div>
                    <div class="monitor-card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="performance-gauge">
                                    <div class="gauge-value gauge-good" id="dbConnections">0</div>
                                    <small>Active Connections</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="performance-gauge">
                                    <div class="gauge-value gauge-good" id="dbQueryTime">0ms</div>
                                    <small>Avg Query Time</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="performance-gauge">
                                    <div class="gauge-value gauge-good" id="dbSize">0 MB</div>
                                    <small>Database Size</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div class="tab-pane fade" id="alerts" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-bell"></i> Recent Alerts</h5>
                                <button class="btn btn-outline-light btn-sm" onclick="clearAlerts()">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>
                            <div class="monitor-card-body">
                                <div id="alertsList" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Alerts will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="monitor-card">
                            <div class="monitor-card-header">
                                <h5><i class="fas fa-cog"></i> Alert Configuration</h5>
                            </div>
                            <div class="monitor-card-body">
                                <form id="alertConfigForm">
                                    <div class="alert-config-item">
                                        <h6>CPU Usage Alert</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="cpuAlert" checked>
                                            <label class="form-check-label" for="cpuAlert">Enable</label>
                                        </div>
                                        <div class="input-group input-group-sm mt-2">
                                            <span class="input-group-text">Threshold</span>
                                            <input type="number" class="form-control" id="cpuThreshold" value="80">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-config-item">
                                        <h6>Memory Usage Alert</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="memoryAlert" checked>
                                            <label class="form-check-label" for="memoryAlert">Enable</label>
                                        </div>
                                        <div class="input-group input-group-sm mt-2">
                                            <span class="input-group-text">Threshold</span>
                                            <input type="number" class="form-control" id="memoryThreshold" value="85">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-config-item">
                                        <h6>Queue Size Alert</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="queueAlert" checked>
                                            <label class="form-check-label" for="queueAlert">Enable</label>
                                        </div>
                                        <div class="input-group input-group-sm mt-2">
                                            <span class="input-group-text">Threshold</span>
                                            <input type="number" class="form-control" id="queueThreshold" value="100">
                                            <span class="input-group-text">items</span>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables for charts and data
let charts = {};
let refreshIntervals = {};
let isRefreshing = false;

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    startRealTimeUpdates();
    loadInitialData();
});

// Initialize all charts
function initializeCharts() {
    // Resource Chart
    const resourceCtx = document.getElementById('resourceChart').getContext('2d');
    charts.resource = new Chart(resourceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU %',
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    data: []
                },
                {
                    label: 'Memory %',
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    data: []
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Network Chart
    const networkCtx = document.getElementById('networkChart').getContext('2d');
    charts.network = new Chart(networkCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'In (MB/s)',
                    borderColor: '#17a2b8',
                    data: []
                },
                {
                    label: 'Out (MB/s)',
                    borderColor: '#ffc107',
                    data: []
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Delivery Chart
    const deliveryCtx = document.getElementById('deliveryChart').getContext('2d');
    charts.delivery = new Chart(deliveryCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Emails Sent',
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    data: []
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Delivery Pie Chart
    const deliveryPieCtx = document.getElementById('deliveryPieChart').getContext('2d');
    charts.deliveryPie = new Chart(deliveryPieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Delivered', 'Pending', 'Bounced', 'Deferred'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Response Time Chart
    const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
    charts.responseTime = new Chart(responseCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Response Time (ms)',
                backgroundColor: '#007bff',
                data: []
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Throughput Chart
    const throughputCtx = document.getElementById('throughputChart').getContext('2d');
    charts.throughput = new Chart(throughputCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Requests/sec',
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                data: []
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Start real-time updates
function startRealTimeUpdates() {
    // Update system metrics every 5 seconds
    refreshIntervals.metrics = setInterval(refreshSystemMetrics, 5000);
    
    // Update delivery stats every 30 seconds
    refreshIntervals.delivery = setInterval(refreshDeliveryStats, 30000);
    
    // Update queue status every 10 seconds
    refreshIntervals.queue = setInterval(refreshQueue, 10000);
    
    // Update logs every 15 seconds
    refreshIntervals.logs = setInterval(refreshLogs, 15000);
}

// Load initial data
function loadInitialData() {
    refreshSystemMetrics();
    refreshDeliveryStats();
    refreshQueue();
    refreshLogs();
    loadAlerts();
}

// Refresh all data
function refreshAllData() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.classList.add('spinning');
    
    Promise.all([
        refreshSystemMetrics(),
        refreshDeliveryStats(),
        refreshQueue(),
        refreshLogs()
    ]).finally(() => {
        isRefreshing = false;
        refreshIcon.classList.remove('spinning');
    });
}

// System Metrics Functions
async function refreshSystemMetrics() {
    try {
        const response = await fetch('/api/metrics/system');
        const data = await response.json();
        
        if (data.status === 'success') {
            updateSystemMetrics(data.data);
            updateResourceChart(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch system metrics:', error);
    }
}

function updateSystemMetrics(data) {
    // Update CPU usage
    const cpuElement = document.getElementById('cpuUsage');
    cpuElement.textContent = `${data.cpu}%`;
    cpuElement.className = `gauge-value ${getGaugeClass(data.cpu, 70, 90)}`;
    
    // Update memory usage
    const memoryElement = document.getElementById('memoryUsage');
    memoryElement.textContent = `${data.memory}%`;
    memoryElement.className = `gauge-value ${getGaugeClass(data.memory, 75, 90)}`;
    
    // Update disk usage
    const diskElement = document.getElementById('diskUsage');
    diskElement.textContent = `${data.disk}%`;
    diskElement.className = `gauge-value ${getGaugeClass(data.disk, 80, 95)}`;
    
    // Update network stats
    document.getElementById('networkIn').textContent = `${data.network_in} MB`;
    document.getElementById('networkOut').textContent = `${data.network_out} MB`;
    
    // Update system status
    updateSystemStatus(data);
}

function updateSystemStatus(data) {
    const statusElement = document.getElementById('systemStatus');
    const uptimeElement = document.getElementById('systemUptime');
    
    if (data.status === 'healthy') {
        statusElement.innerHTML = '<span class="status-indicator status-online"></span>Online';
    } else if (data.status === 'warning') {
        statusElement.innerHTML = '<span class="status-indicator status-warning"></span>Warning';
    } else {
        statusElement.innerHTML = '<span class="status-indicator status-offline"></span>Critical';
    }
    
    uptimeElement.textContent = `Uptime: ${data.uptime || '--'}`;
}

function updateResourceChart(data) {
    const chart = charts.resource;
    const now = new Date().toLocaleTimeString();
    
    // Keep only last 20 data points
    if (chart.data.labels.length >= 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
        chart.data.datasets[1].data.shift();
    }
    
    chart.data.labels.push(now);
    chart.data.datasets[0].data.push(data.cpu);
    chart.data.datasets[1].data.push(data.memory);
    
    chart.update('none');
}

function getGaugeClass(value, warningThreshold, criticalThreshold) {
    if (value >= criticalThreshold) return 'gauge-critical';
    if (value >= warningThreshold) return 'gauge-warning';
    return 'gauge-good';
}

// Delivery Stats Functions
async function refreshDeliveryStats() {
    try {
        const response = await fetch('/api/metrics/delivery');
        const data = await response.json();
        
        if (data.status === 'success') {
            updateDeliveryStats(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch delivery stats:', error);
    }
}

function updateDeliveryStats(data) {
    // Update main metrics
    document.getElementById('emailsToday').textContent = data.emails_today || 0;
    document.getElementById('successRate').textContent = `${data.success_rate || 0}%`;
    
    // Update delivery breakdown
    document.getElementById('deliveredCount').textContent = data.delivered || 0;
    document.getElementById('pendingCount').textContent = data.pending || 0;
    document.getElementById('bouncedCount').textContent = data.bounced || 0;
    document.getElementById('deferredCount').textContent = data.deferred || 0;
    
    // Update pie chart
    charts.deliveryPie.data.datasets[0].data = [
        data.delivered || 0,
        data.pending || 0,
        data.bounced || 0,
        data.deferred || 0
    ];
    charts.deliveryPie.update();
}

// Queue Functions
async function refreshQueue() {
    try {
        const response = await fetch('/api/metrics/queue');
        const data = await response.json();
        
        if (data.status === 'success') {
            updateQueueStatus(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch queue status:', error);
    }
}

function updateQueueStatus(data) {
    document.getElementById('queueSize').textContent = data.size || 0;
    document.getElementById('queueStatus').textContent = data.status || 'Unknown';
    document.getElementById('processingRate').textContent = `${data.processing_rate || 0}/min`;
    document.getElementById('avgWaitTime').textContent = `${data.avg_wait_time || 0}s`;
    document.getElementById('failedJobs').textContent = data.failed_jobs || 0;
    
    // Update queue list
    updateQueueList(data.items || []);
}

function updateQueueList(items) {
    const queueList = document.getElementById('queueList');
    
    if (items.length === 0) {
        queueList.innerHTML = '<div class="text-center text-muted p-4">Queue is empty</div>';
        return;
    }
    
    let html = '';
    items.forEach(item => {
        html += `<div class="queue-item ${item.status}">
            <div>
                <strong>${item.subject || 'No Subject'}</strong><br>
                <small>To: ${item.to || 'Unknown'}</small>
            </div>
            <div class="text-end">
                <span class="badge badge-status bg-${getStatusColor(item.status)}">${item.status}</span><br>
                <small>${item.created_at || 'Unknown'}</small>
            </div>
        </div>`;
    });
    
    queueList.innerHTML = html;
}

function getStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'processing': 'info',
        'completed': 'success',
        'failed': 'danger'
    };
    return colors[status] || 'secondary';
}

// Queue control functions
async function pauseQueue() {
    try {
        const response = await fetch('/api/queue/pause', { method: 'POST' });
        const result = await response.json();
        
        if (result.status === 'success') {
            document.getElementById('queueStatus').textContent = 'Paused';
        }
    } catch (error) {
        console.error('Failed to pause queue:', error);
    }
}

async function resumeQueue() {
    try {
        const response = await fetch('/api/queue/resume', { method: 'POST' });
        const result = await response.json();
        
        if (result.status === 'success') {
            document.getElementById('queueStatus').textContent = 'Running';
        }
    } catch (error) {
        console.error('Failed to resume queue:', error);
    }
}

// Logs Functions
async function refreshLogs() {
    try {
        const level = document.getElementById('logLevel').value;
        const response = await fetch(`/api/logs?level=${level}&limit=100`);
        const data = await response.json();
        
        if (data.status === 'success') {
            updateLogs(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch logs:', error);
    }
}

function updateLogs(logs) {
    const logContainer = document.getElementById('logContainer');
    
    if (!logs || logs.length === 0) {
        logContainer.innerHTML = '<div class="text-center text-muted">No logs found</div>';
        return;
    }
    
    let html = '';
    logs.forEach(log => {
        html += `<div class="log-entry log-${log.level}">
            [${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}
        </div>`;
    });
    
    logContainer.innerHTML = html;
    logContainer.scrollTop = logContainer.scrollHeight;
}

async function clearLogs() {
    if (confirm('Are you sure you want to clear all logs?')) {
        try {
            const response = await fetch('/api/logs', { method: 'DELETE' });
            const result = await response.json();
            
            if (result.status === 'success') {
                document.getElementById('logContainer').innerHTML = 
                    '<div class="text-center text-muted">Logs cleared</div>';
            }
        } catch (error) {
            console.error('Failed to clear logs:', error);
        }
    }
}

// Alerts Functions
async function loadAlerts() {
    try {
        const response = await fetch('/api/alerts');
        const data = await response.json();
        
        if (data.status === 'success') {
            updateAlertsList(data.data);
        }
    } catch (error) {
        console.error('Failed to fetch alerts:', error);
    }
}

function updateAlertsList(alerts) {
    const alertsList = document.getElementById('alertsList');
    
    if (!alerts || alerts.length === 0) {
        alertsList.innerHTML = '<div class="text-center text-muted p-4">No recent alerts</div>';
        return;
    }
    
    let html = '';
    alerts.forEach(alert => {
        const alertClass = alert.severity === 'critical' ? 'danger' : 
                          alert.severity === 'warning' ? 'warning' : 'info';
        
        html += `<div class="alert alert-${alertClass} d-flex justify-content-between align-items-center">
            <div>
                <strong>${alert.title}</strong><br>
                <small>${alert.message}</small>
            </div>
            <div class="text-end">
                <small>${alert.timestamp}</small>
            </div>
        </div>`;
    });
    
    alertsList.innerHTML = html;
}

async function clearAlerts() {
    if (confirm('Are you sure you want to clear all alerts?')) {
        try {
            const response = await fetch('/api/alerts', { method: 'DELETE' });
            const result = await response.json();
            
            if (result.status === 'success') {
                document.getElementById('alertsList').innerHTML = 
                    '<div class="text-center text-muted p-4">All alerts cleared</div>';
            }
        } catch (error) {
            console.error('Failed to clear alerts:', error);
        }
    }
}

// Alert configuration
document.getElementById('alertConfigForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const config = {
        cpu_alert: document.getElementById('cpuAlert').checked,
        cpu_threshold: document.getElementById('cpuThreshold').value,
        memory_alert: document.getElementById('memoryAlert').checked,
        memory_threshold: document.getElementById('memoryThreshold').value,
        queue_alert: document.getElementById('queueAlert').checked,
        queue_threshold: document.getElementById('queueThreshold').value
    };
    
    try {
        const response = await fetch('/api/alerts/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Show success message
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            setTimeout(() => btn.innerHTML = originalText, 2000);
        }
    } catch (error) {
        console.error('Failed to save alert configuration:', error);
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    Object.values(refreshIntervals).forEach(interval => clearInterval(interval));
});

// Log level filter change
document.getElementById('logLevel').addEventListener('change', refreshLogs);
</script>
{% endblock %}